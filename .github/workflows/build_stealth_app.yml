name: Stealth Patcher Full Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码 (Checkout)
        uses: actions/checkout@v4

      - name: 2. 初始化 Java 环境 (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 3. 补全 Gradle 环境
        run: |
          # 进入项目根目录
          cd app
          
          # 下载 Gradle Wrapper
          G_VER="8.1.1"
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradlew -O gradlew
          chmod +x gradlew
          mkdir -p gradle/wrapper
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          
          # 写入 Wrapper 配置
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-$G_VER-bin.zip" > gradle/wrapper/gradle-wrapper.properties
          
          # 【防御性编程】同时在 app 目录生成属性文件，双重保险
          echo "android.useAndroidX=true" > gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m" >> gradle.properties
          
          echo "[√] Gradle 环境初始化完成"

      - name: 4. 提取 Magiskboot 并注入 Assets
        run: |
          # 定义最终 Assets 路径 (针对双层 app 结构: 外层app/内层app模块/...)
          ASSETS_DIR="app/app/src/main/assets"
          BIN_DIR="$ASSETS_DIR/bin/arm64-v8a"
          mkdir -p "$BIN_DIR"
          
          # 获取 Magisk 最新二进制
          API_URL="https://api.github.com/repos/topjohnwu/Magisk/releases/latest"
          DOWNLOAD_URL=$(curl -s $API_URL | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -n 1)
          
          echo "正在下载 Magisk 并提取二进制..."
          wget -q "$DOWNLOAD_URL" -O magisk.apk
          unzip -q magisk.apk "lib/arm64-v8a/libmagiskboot.so" -d magisk_out
          
          # 移动并重命名为 magiskboot
          cp magisk_out/lib/arm64-v8a/libmagiskboot.so "$BIN_DIR/magiskboot"
          
          # 检查并注入 kernel_patches 脚本
          if [ -d "kernel_patches" ]; then
            cp -r kernel_patches/* "$ASSETS_DIR/"
            echo "[√] 成功将 kernel_patches 脚本存入 Assets"
          fi
          
          echo "[√] Magiskboot 部署完成"

      - name: 5. 执行正式编译 (带 AndroidX 强制参数)
        run: |
          cd app
          # 使用 -P 注入属性是解决 checkReleaseAarMetadata FAILED 的最终绝招
          ./gradlew assembleRelease --no-daemon \
            -Pandroid.useAndroidX=true \
            -Pandroid.enableJetifier=true

      - name: 6. 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: StealthManager-Release
          # 匹配编译生成的 Release APK
          path: "app/app/build/outputs/apk/release/*.apk"