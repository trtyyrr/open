name: Stealth Patcher Full Build

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 初始化 Java 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 3. 补全 Gradle 环境 (进入 App 目录)
        run: |
          # 【关键】进入包含 Android 项目的目录
          cd App
          
          # 动态下载 Gradle 运行环境
          G_VER="8.1.1"
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradlew -O gradlew
          chmod +x gradlew
          mkdir -p gradle/wrapper
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          
          # 强制写入 AndroidX 修复配置到 App 目录下
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-$G_VER-bin.zip" > gradle/wrapper/gradle-wrapper.properties
          echo "android.useAndroidX=true" > gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          
          echo "[√] Gradle 环境在 App 目录内初始化成功"

      - name: 4. 整合 Kernel Patches 脚本
        run: |
          # 创建 App 的资源目录
          mkdir -p App/app/src/main/assets/
          
          # 将根目录下的 kernel_patches 拷贝进去，这样 App 运行就能找到它
          if [ -d "kernel_patches" ]; then
            cp -r kernel_patches/* App/app/src/main/assets/
            echo "[√] 已将修补脚本注入 Assets"
          else
            echo "[!] 警告: 未找到 kernel_patches 文件夹"
          fi

      - name: 5. 注入 Magiskboot 引擎
        run: |
          # 进入资源目录
          TARGET_DIR="App/app/src/main/assets/bin/arm64-v8a"
          mkdir -p $TARGET_DIR
          
          # 获取 Magisk 最新二进制
          API_URL="https://api.github.com/repos/topjohnwu/Magisk/releases/latest"
          DOWNLOAD_URL=$(curl -s $API_URL | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -n 1)
          wget -q "$DOWNLOAD_URL" -O magisk.apk
          unzip -q magisk.apk -d magisk_tmp
          
          # 提取并重命名 magiskboot
          cp magisk_tmp/lib/arm64-v8a/libmagiskboot.so $TARGET_DIR/magiskboot
          echo "[√] Magiskboot 引擎部署完毕"

      - name: 6. 运行编译
        run: |
          cd App
          # 使用 --no-daemon 确保在全新的环境中读取 gradle.properties
          ./gradlew assembleRelease --no-daemon

      - name: 7. 发布 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: StealthPatcher-Release
          # 这里的路径必须指向编译生成的具体位置
          path: "App/app/build/outputs/apk/release/*.apk"