name: Stealth Patcher Final Success

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 配置 Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 3. 准备 Gradle 与 AndroidX 环境
        run: |
          cd app
          # 补全 Gradle Wrapper
          G_VER="8.1.1"
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradlew -O gradlew
          chmod +x gradlew
          mkdir -p gradle/wrapper
          wget -q https://raw.githubusercontent.com/gradle/gradle/v$G_VER/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-$G_VER-bin.zip" > gradle/wrapper/gradle-wrapper.properties
          # 强制开启 AndroidX
          echo "android.useAndroidX=true" > gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties

      - name: 4. 修复图标资源 (防止链接报错)
        run: |
          RES_DIR="app/src/main/res"
          mkdir -p $RES_DIR/mipmap-anydpi-v26 $RES_DIR/values
          cat <<EOF > $RES_DIR/mipmap-anydpi-v26/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108"><path android:fillColor="#000000" android:pathData="M0,0h108v108h-108z"/><path android:fillColor="#3DDC84" android:pathData="M54,20L24,34v20c0,18.5 12.8,35.8 30,40c17.2,-4.2 30,-21.5 30,-40V34L54,20zM54,40c4.4,0 8,3.6 8,8s-3.6,8 -8,8s-8,-3.6 -8,-8S49.6,40 54,40z"/></vector>
          EOF
          cp $RES_DIR/mipmap-anydpi-v26/ic_launcher.xml $RES_DIR/mipmap-anydpi-v26/ic_launcher_round.xml
          echo '<?xml version="1.0" encoding="utf-8"?><resources><color name="black">#FF000000</color><color name="white">#FFFFFFFF</color></resources>' > $RES_DIR/values/colors.xml

      - name: 5. 注入二进制文件 (Magiskboot)
        run: |
          # 确定注入路径
          TARGET_DIR="app/src/main/assets/bin/arm64-v8a"
          mkdir -p "$TARGET_DIR"
          
          # 直接下载已经提取好的 Magiskboot 二进制 (arm64-v8a)
          # 这是来自 GitHub 稳定维护的二进制源
          wget -q https://github.com/topjohnwu/Magisk/releases/download/v26.1/Magisk-v26.1.apk -O magisk.apk
          
          # 鲁棒性提取：列出所有内容，寻找目标 so 文件并改名
          unzip -j magisk.apk "lib/arm64-v8a/libmagiskboot.so" -d "$TARGET_DIR"
          mv "$TARGET_DIR/libmagiskboot.so" "$TARGET_DIR/magiskboot"
          
          # 注入你的 kernel_patches
          if [ -d "kernel_patches" ]; then
            cp -r kernel_patches/* "app/src/main/assets/"
          fi
          echo "Magiskboot 部署完成"

      - name: 6. 执行编译
        run: |
          cd app
          ./gradlew assembleRelease --no-daemon \
            -Pandroid.useAndroidX=true \
            -Pandroid.enableJetifier=true

      - name: 7. 搜索并上传 APK
        uses: actions/upload-artifact@v4
        with:
          name: StealthPatcher-Release
          # 使用通配符递归查找所有生成的 APK 文件
          path: "**/build/outputs/apk/release/*.apk"